<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Hammersmith+One&display=swap" rel="stylesheet">
<link rel="icon" href="assets/CarbonX-icon(dark).png" type="image/png" media="(prefers-color-scheme: dark)">
<link rel="icon" href="assets/CarbonX-icon(light).png" type="image/png" media="(prefers-color-scheme: light)">
<style>
    :root {
        color-scheme: light dark;
        --navy: #223f43;
        --blue: #59A5B2;
        --light-blue: #c5e4e7;
        --cream: #f1e0ce;
        --yellow: #fbcc58;
        --black: #020202;
        --white: #f4f4f4;
        --background-gradient: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%);
        --grey: #eaeaea;
        --dark-grey: #a9a9a9;
        --border-color: var(--dark-grey);
        --interactive-bg: light-dark(var(--white), var(--black));
        --card-bg: light-dark(var(--white), var(--black));
        --modal-bg: light-dark(var(--white), var(--black));
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: "Figtree", sans-serif;
        background: var(--background-gradient);
        color: light-dark(var(--black), var(--white));
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
    }

    .guide-card {
        width: 100%;
        max-width: 900px;
        background: var(--card-bg);
        padding: 50px 60px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .guide-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .header-title h1 {
        font-size: 40px;
        color: light-dark(var(--navy), var(--blue));
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .header-title p {
        color: light-dark(var(--black), var());
        font-size: 16px;
    }
    
    .header-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .form-logo {
        width: 50px;
        height: 50px;
        margin-bottom: 20px;
    }
    
    .skip-link {
        color: light-dark(var(--navy), var(--blue));
        text-decoration: underline;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }
    
    .task-accordion .task {
        border-bottom: 1px solid var(--dark-grey);
    }
    
    .task:last-child {
        border-bottom: none;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: light-dark(var(--black), var(--white));
    }

    .task-header svg {
        width: 20px;
        height: 20px;
        transition: transform 0.3s;
    }
    
    .task.active .task-header svg {
        transform: rotate(180deg);
    }

    .task-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, padding 0.4s ease-out;
    }

    .task-content-inner {
        display: flex;
        gap: 30px;
        padding: 10px 10px 30px 10px;
        align-items: flex-start;
    }
    
    .interactive-preview {
        flex: 1.5;
        background-color: var(--interactive-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .task-steps {
        flex: 1;
    }

    .task-steps p {
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .inventory-header, .settings-header, .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .inventory-header .title h3, .settings-header h3, .dashboard-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: light-dark(var(--black), var(--white));
    }
    .inventory-header .title p, .settings-header p, .dashboard-header p {
        font-size: 13px;
        color: light-dark(var(--black), var(--white));
    }

    .inventory-actions .add-new-btn {
        color: var(--black);
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
        background-color: var(--yellow);
    }
    .inventory-actions .add-new-btn:hover { background-color: var(--cream); }
    
    .inventory-table { width: 100%; border-collapse: collapse; background-color: light-dark(var(--white), var(--black)); }
    .inventory-table th, .inventory-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: middle;}
    .inventory-table th { font-weight: 600; color: light-dark(var(--black), var(--white)); }
    .inventory-table .view-btn, .inventory-table .dpp-link { color: light-dark(var(--navy), var(--blue)); font-weight: bold; text-decoration: underline; cursor: pointer; }
    .no-products-message { text-align: center; padding: 40px; color: var(--dark-grey); }
    
    .calculate-lca-btn-inline {
        background-color: light-dark(var(--navy), var(--blue)); color: light-dark(var(--white),var(--black)); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-family: "Figtree", sans-serif; transition: background-color 0.2s; font-weight: bold
    }
    .calculate-lca-btn-inline:hover { background-color: light-dark(var(--blue), var(--navy)); color: light-dark(var(--black), var(--white)) }

    .dashboard-content { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .dashboard-card { background-color: var(--interactive-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
    .dashboard-card h4 { font-size: 14px; margin-bottom: 15px; }
    .emissions-value { font-size: 24px; font-weight: bold; }
    .activities-list .activity { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
    .activity .status { padding: 3px 8px; border-radius: 12px; font-size: 11px; }
    .status.completed { background-color: var(--yellow); color: var(--black); }
    .status.inprogress { background-color: var(--light-blue); color: var(--black); }
    .status.not-started {
    background-color: var(--grey);
    color: var(--black);
}
    .target-input-editable { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: light-dark(var(--black), var(--white)); }
    
    .pie-chart-container { display: flex; align-items: center; gap: 20px; padding: 20px; }
    .pie-chart { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--blue) 0deg, #e9ecef 0deg); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .pie-chart-center { width: 110px; height: 110px; background: var(--interactive-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .pie-chart-center span { font-size: 28px; font-weight: bold; color: var(--blue); }
    .pie-legend .legend-text .value { font-weight: 600; color: light-dark(var(--black), var(--white)); }

    .guide-footer { text-align: center; margin-top: 40px; }
    button#dashboardButton { background: var(--dark-grey); cursor: not-allowed; padding: 15px 30px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; color: light-dark(var(--white), var(--black)); transition: background 0.3s, transform 0.3s; }
    button#dashboardButton.active { background: light-dark(var(--navy), var(--blue)); cursor: pointer; }
    button#dashboardButton.active:hover { background: light-dark(var(--blue), var(--navy)); transform: translateY(-2px); color: light-dark(var(--white), var(--white)); }

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%; /* Fixes centering */
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.close-modal-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: light-dark(var(--black), var(--white));
}

.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
.modal-content {
    background: var(--modal-bg);
    color: light-dark(var(--black), var(--white));
    padding: 30px;
    border-radius: 16px;
    width: 100%; /* Let the container control the width */
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(0.95);
    transition: transform 0.3s;
}
    .modal-overlay.active .modal-content { transform: scale(1); }
#addProductModal .modal-content {
    max-width: 420px;
}
#addProductForm input[type="text"] {
    background-color: var(--card-bg);
    color: light-dark(var(--black), var(--white));
    border: 1px solid var(--dark-grey); /* Default border color */
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    transition: border-color 0.3s; /* Smooth transition for hover */
}
    .file-drop-area { border: 2px dashed var(--border-color); background-color: var(--card-bg); border-radius: 8px; height: 10vh; display: flex; justify-content: center; align-items: center; }
    .create-dpp-btn {
    width: 100%; /* Make button full-width */
    color: var(--black);
    background: var(--yellow);
    border: none;
    padding: 14px; /* Added for better size */
    border-radius: 8px; /* Rounded corners */
    font-weight: bold;
    font-size: 16px; /* Consistent font size */
    cursor: pointer;
    transition: background-color 0.2s;
    margin-top: 20px; /* Added space above the button */
}

.create-dpp-btn:hover {
    background-color: var(--cream);
}
</style>
</head>
<body>
    <div class="guide-card">
        <div class="guide-header">
            <div class="header-title">
                <h1 id="welcomeMessage">Welcome Name!</h1>
                <p>Let's get you onboarded! Complete the following tasks:</p>
            </div>
            <div class="header-actions">
                 <picture>
    <source srcset="assets/CarbonX-icon(dark).png" media="(prefers-color-scheme: dark)">
    <img src="assets/CarbonX-icon(light).png" alt="CarbonX Logo" class="form-logo">
</picture>
                 <a href="#" class="skip-link">Skip</a>
            </div>
        </div>

        <div class="task-accordion">
            <!-- Task 1 --><div class="task" id="task1">
                <div class="task-header">
                    <span>Task 1 of 3: Add a new product into Inventory</span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="task-content">
                    <div class="task-content-inner">
                        <div class="interactive-preview">
                            <div class="inventory-header">
                                <div class="title"><h3>Inventory</h3><p>Overview of your products.</p></div>
                                <div class="inventory-actions"><button class="add-new-btn">Add New</button></div>
                            </div>
                            <table class="inventory-table">
                                <thead><tr><th>Product Name</th><th>DPP</th><th>kgCO2e</th><th>Uploaded File</th></tr></thead>
                                <tbody><tr><td colspan="4"><div class="no-products-message">Your products will appear here.</div></td></tr></tbody>
                            </table>
                        </div>
                        <div class="task-steps">
                            <p><strong>Step 1:</strong> Click on the Add New button</p>
                            <p><strong>Step 2:</strong> Key in your product name</p>
                            <p><strong>Step 3:</strong> Upload your product's BoM</p>
                            <p><strong>Step 4:</strong> Click on the Create DPP button</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Task 2 --><div class="task" id="task2">
                <div class="task-header">
                    <span>Task 2 of 3: Perform Carbon Calculation & Explore Inventory</span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="task-content">
                     <div class="task-content-inner">
                        <div class="interactive-preview">
                            <div class="inventory-header">
                                <div class="title"><h3>Inventory</h3><p>Overview of your products.</p></div>
                            </div>
                            <table class="inventory-table">
                                <thead><tr><th>Product Name</th><th>DPP</th><th>kgCO2e</th><th>Uploaded File</th></tr></thead>
                                <tbody>
                                    <tr><td colspan="4"><div class="no-products-message">Your new product will appear here after being added in Task 1.</div></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="task-steps">
                            <p><strong>Step 1:</strong> Click on the Calculate LCA button to get your carbon calculations.</p>
                            <p><strong>Step 2:</strong> Click on DPP for product name to view the DPP.</p>
                            <p><strong>Step 3:</strong> Click the View button to view your uploaded BoM.</p>
                        </div>
                    </div>
                </div>
            </div>
             <!-- Task 3 --><div class="task" id="task3">
                <div class="task-header">
                    <span>Task 3 of 3: Explore your dashboard</span>
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="task-content">
                     <div class="task-content-inner">
                        <div class="interactive-preview">
                           <div class="dashboard-header">
                               <div class="title"><h3>Dashboard</h3><p>Overview of your carbon emissions and activities.</p></div>
                           </div>
                           <div class="dashboard-content">
                               <div class="dashboard-card">
                                   <h4>Current Total Carbon Emissions</h4>
                                   <p class="emissions-value">0 kgCO2e</p>
                               </div>
                               <div class="dashboard-card">
                                   <h4>Activities</h4>
<div class="activities-list">
    <div class="activity">
        <span id="textLca">Calculated LCA for...</span>
        <span id="statusLca" class="status not-started">Not Started</span>
    </div>
    <div class="activity">
        <span>Added a New Product</span>
        <span id="statusAddProduct" class="status not-started">Not Started</span>
    </div>
    <div class="activity">
        <span>Complete Onboarding</span>
        <span class="status inprogress">In Progress</span>
    </div>
</div>
                               </div>
                               <!-- Removed Top Contributors of Carbon Emissions card --><!-- <div class="dashboard-card" style="grid-column: span 2;">
                                   <h4>Top Contributors of Carbon Emissions</h4>
                                   <div class="chart-area">
                                       <div class="y-axis"></div>
                                       <div class="bar-chart-container">
                                            <div class="no-products-message">Calculate LCA for products in Task 2 to see data here.</div>
                                       </div>
                                   </div>
                               </div> --><div class="dashboard-card" style="grid-column: span 2;"> <!-- Make pie chart card span 2 columns --><h4>Efficiency Target</h4>
                                    <div class="pie-chart-container">
                                        <div class="pie-chart">
                                            <div class="pie-chart-center">
                                                <span>0%</span>
                                            </div>
                                        </div>
                                        <div class="pie-legend">
                                            <div class="legend-item">
                                                 <div class="legend-color" style="background-color: var(--primary-color);"></div>
                                                 <div class="legend-text">Actual Target: <span class="value" id="legend-actual">0 kgCO2e</span></div>
                                            </div>
                                            <div class="legend-item">
                                                <div class="legend-color" style="background-color: #e9ecef;"></div>
                                                 <div class="legend-text">Amount Left: <span class="value" id="legend-left">0 kgCO2e</span></div>
                                            </div>
                                         </div>
                                    </div>
                               </div>
                           </div>
                        </div>
                        <div class="task-steps">
                             <p><strong>Step 1:</strong> View the total carbon emissions, list of activities and efficiency targets here.</p>
                             <p><strong>Step 2:</strong> Key in your efficiency target.</p>
                             <div class="form-group">
                                 <label for="efficiencyTargetInput" style="font-weight: normal; font-size: 14px; margin-bottom: 5px;">Efficiency Target (kgCO2e)</label>
                                 <input type="number" step="0.01" id="efficiencyTargetInput" class="target-input-editable" value="0.500">
                             </div>
                             <p><strong>Step 3:</strong> Look at your current efficiency target.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="guide-footer">
            <button id="dashboardButton">Go to Dashboard</button>
        </div>
    </div>

    <!-- Add Product Modal --><div id="addProductModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add a New Product</h2>
                <button class="close-modal-btn">&times;</button>
            </div>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>File</label>
                    <div class="file-drop-area">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        <input type="file" id="fileUpload" class="file-input" hidden>
                    </div>
                    <p class="file-attached-info">File Attached: <strong id="fileName"></strong></p>
                </div>
                <button type="submit" class="create-dpp-btn">Create DPP</button>
            </form>
        </div>
    </div>

    <!-- DPP Modal --><div id="dppModal" class="modal-overlay">
        <div class="modal-content">
             <div class="modal-header">
                <h2 id="dppProductName">Digital Product Passport</h2>
                <button class="close-modal-btn">&times;</button>
            </div>
            
            <div class="dpp-section">
                <h3>Product Overview</h3>
                <div class="dpp-grid">
                    <div class="dpp-item"><strong>Part Name:</strong> <span id="dppPartName"></span></div>
                    <div class="dpp-item"><strong>Part Number:</strong> <span id="dppPartNumber"></span></div>
                </div>
                 <div class="dpp-item" style="grid-column: span 2;"><strong>Description:</strong> <span id="dppDescription"></span></div>
                 <div class="dpp-item" style="grid-column: span 2;"><strong>Application:</strong> <span id="dppApplication"></span></div>
            </div>

            <div class="dpp-section">
                <h3>Bill of Materials</h3>
                <table class="dpp-table">
                    <thead><tr><th>Item</th><th>Quantity</th><th>Part Name</th><th>Description</th><th>Material</th></tr></thead>
                    <tbody id="dppBomTable"></tbody>
                </table>
            </div>
            
            <div class="dpp-section">
                <h3>Technical Specifications</h3>
                <div class="dpp-grid" id="dppTechSpecs"></div>
            </div>

             <div class="dpp-section">
                <h3>Features & Benefits</h3>
                <ul class="dpp-list" id="dppFeatures"></ul>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Welcome message and skip button logic ---
        const welcomeMessage = document.getElementById('welcomeMessage');
        const fullName = localStorage.getItem('signupFullName');

        if (fullName) {
            const capitalizedName = fullName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            welcomeMessage.textContent = `Welcome, ${capitalizedName}!`;
        } else {
            welcomeMessage.textContent = 'Welcome!';
        }

        const skipButton = document.querySelector('.skip-link');
        skipButton.addEventListener('click', (event) => {
            event.preventDefault();
            window.location.href = 'dashboard.html';
        });

        // --- Application logic ---
        let products = [];
        let isFirstLcaDone = false;
        
        const statusLcaText = document.getElementById('textLca');
        const statusLca = document.getElementById('statusLca');
        const statusAddProduct = document.getElementById('statusAddProduct');
        
        const dppData = { "dpp": { "productOverview": { "partName": "Handheld Hammer Drill", "partNumber": "HHD-2000", "description": "A robust and versatile handheld hammer drill designed for efficient drilling into various materials, including concrete, masonry, wood, and metal. Features a durable steel gear train for reliable performance and extended lifespan.", "application": "Ideal for professional construction, DIY projects, and general maintenance tasks requiring powerful rotational and percussive drilling." }, "billOfMaterials": [ { "item": 1, "quantity": 1, "partName": "Carrier 1 + Sun Gear 2", "description": "Module: 0.685", "material": "Steel" }, { "item": 4, "quantity": 1, "partName": "Carrier 2 + Sun Gear 3", "description": "Module: 0.706", "material": "Steel" }, { "item": 5, "quantity": 5, "partName": "Planet Gear 3", "description": "Module: 0.7", "material": "Steel" }, { "item": 6, "quantity": 1, "partName": "Ring Gear 3", "description": "Ring Gear 3", "material": "Steel" }, { "item": 7, "quantity": 5, "partName": "Planet Gear 2", "description": "Module: 0.685", "material": "Steel" }, { "item": 8, "quantity": 3, "partName": "Planet Gear 1", "description": "Module: 0.6", "material": "Steel" }, { "item": 9, "quantity": 1, "partName": "Carrier 3", "description": "Carrier 3", "material": "Steel" }, { "item": 10, "quantity": 1, "partName": "Ring Gear 2", "description": "Ring Gear 2", "material": "Steel" }, { "item": 11, "quantity": 1, "partName": "Ring Gear 1", "description": "Ring Gear 1", "material": "Steel" } ], "technicalSpecifications": { "powerInput": "800W", "noLoadSpeed": "0-3000 RPM", "impactRate": "0-48000 BPM", "chuckType": "13mm Keyless Chuck", "maxDrillingDiameter": { "concrete": "16mm", "steel": "13mm", "wood": "30mm" }, "weight": "2.5 kg", "voltage": "230V / 50Hz", "dimensions": "300mm x 70mm x 220mm" }, "featuresAndBenefits": [ "Powerful 800W motor for high performance.", "Durable all-steel gearing for long tool life.", "Dual mode: Hammer action and rotary only.", "Variable speed control for precision.", "Ergonomic design with auxiliary handle." ] } };

        const tasks = document.querySelectorAll('.task');
        const dashboardButton = document.getElementById('dashboardButton');
        const completedTasks = new Set();
        const efficiencyTargetInput = document.getElementById('efficiencyTargetInput');

        tasks.forEach(task => {
            const header = task.querySelector('.task-header');
            const content = task.querySelector('.task-content');
            header.addEventListener('click', () => {
                const isActive = task.classList.contains('active');
                tasks.forEach(t => {
                    t.classList.remove('active');
                    t.querySelector('.task-content').style.maxHeight = null;
                });
                if (!isActive) {
                    task.classList.add('active');
                    content.style.maxHeight = content.scrollHeight + "px";
                    completedTasks.add(task.id);
                    if (completedTasks.size === tasks.length) {
                        dashboardButton.classList.add('active');
                    }
                }
            });
        });

        dashboardButton.addEventListener('click', () => {
            if (dashboardButton.classList.contains('active')) {
                const totalLca = products.reduce((sum, p) => sum + p.lca, 0);
                sessionStorage.setItem('products', JSON.stringify(products));
                sessionStorage.setItem('lcaValue', totalLca);
                sessionStorage.setItem('efficiencyTarget', efficiencyTargetInput.value);
                window.location.href = 'dashboard.html';
            }
        });

        const addProductModal = document.getElementById('addProductModal');
        const openAddProductBtn = document.querySelector('#task1 .add-new-btn');
        const closeAddProductBtn = addProductModal.querySelector('.close-modal-btn');
        openAddProductBtn.addEventListener('click', () => addProductModal.classList.add('active'));
        const closeAddModal = () => addProductModal.classList.remove('active');
        closeAddProductBtn.addEventListener('click', closeAddModal);
        addProductModal.addEventListener('click', (e) => { if (e.target === addProductModal) closeAddModal(); });
        
        const fileDropArea = addProductModal.querySelector('.file-drop-area');
        const fileInput = addProductModal.querySelector('#fileUpload');
        const fileNameDisplay = addProductModal.querySelector('#fileName');
        const fileAttachedInfo = addProductModal.querySelector('.file-attached-info');
        fileDropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileAttachedInfo.style.display = 'block';
            }
        });
        
        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const productName = document.getElementById('productName').value;
            const file = fileInput.files[0];
            if(productName && file){
                const newProduct = { id: Date.now(), name: productName, file: file, lca: 0 };
                products.push(newProduct);
                renderInventoryTables();
                document.getElementById('addProductForm').reset();
                fileAttachedInfo.style.display = 'none';
                
                statusAddProduct.textContent = 'Completed';
                statusAddProduct.classList.remove('not-started');
                statusAddProduct.classList.add('completed');
                
                closeAddModal();
            } else {
                alert("Please provide a product name and a file.");
            }
        });

        const dppModal = document.getElementById('dppModal');
        const closeDppBtn = dppModal.querySelector('.close-modal-btn');
        closeDppBtn.addEventListener('click', () => dppModal.classList.remove('active'));
        dppModal.addEventListener('click', (e) => { if (e.target === dppModal) dppModal.classList.remove('active'); });

        const pieChart = document.querySelector('#task3 .pie-chart');
        const pieChartText = document.querySelector('#task3 .pie-chart-center span');
        const emissionsValueEl = document.querySelector('#task3 .emissions-value');
        const legendActual = document.querySelector('#legend-actual');
        const legendLeft = document.querySelector('#legend-left');

        // --- RESTORED FUNCTION LOGIC ---
        function renderInventoryTables() {
            const tableBody1 = document.querySelector('#task1 .inventory-table tbody');
            const tableBody2 = document.querySelector('#task2 .inventory-table tbody');
            tableBody1.innerHTML = '';
            tableBody2.innerHTML = '';

            if (products.length === 0) {
                const placeholder = `<tr><td colspan="4"><div class="no-products-message">Your products will appear here.</div></td></tr>`;
                tableBody1.innerHTML = placeholder;
                tableBody2.innerHTML = placeholder.replace('Your products', 'Your new product');
                return;
            }

            products.forEach(p => {
                tableBody1.innerHTML += `<tr><td>${p.name}</td><td>-</td><td>-</td><td>${p.file.name}</td></tr>`;
                
                const lcaCell = p.lca > 0 ? p.lca.toFixed(3) : `<button class="calculate-lca-btn-inline" data-id="${p.id}">Calculate LCA</button>`;
                tableBody2.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td class="dpp-cell"><a href="#" class="dpp-link" data-id="${p.id}">View DPP</a></td>
                        <td>${lcaCell}</td>
                        <td class="view-btn" data-id="${p.id}">View</td>
                    </tr>`;
            });
        }

        function updateDashboardCharts() {
            const totalLca = products.reduce((sum, p) => sum + p.lca, 0);
            emissionsValueEl.textContent = `${totalLca.toFixed(3)} kgCO2e`;
            
            const target = parseFloat(efficiencyTargetInput.value) || 0;
            let percentage = 0;
            if (target > 0) percentage = Math.min((totalLca / target) * 100, 100);
            const angle = (percentage / 100) * 360;
            pieChart.style.background = `conic-gradient(var(--navy) ${angle}deg, #e9ecef ${angle}deg)`;
            pieChartText.textContent = `${Math.round(percentage)}%`;
            legendActual.textContent = `${totalLca.toFixed(3)} kgCO2e`;
            const amountLeft = Math.max(0, target - totalLca);
            legendLeft.textContent = `${amountLeft.toFixed(3)} kgCO2e`;

            const activeTask = document.querySelector('.task.active');
            if (activeTask) {
                const content = activeTask.querySelector('.task-content');
                setTimeout(() => {
                    if (activeTask.classList.contains('active')) {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                }, 10);
            }
        }

        function populateAndShowDpp() {
            const data = dppData.dpp;
            document.getElementById('dppProductName').textContent = `DPP: ${data.productOverview.partName}`;
            document.getElementById('dppPartName').textContent = data.productOverview.partName;
            document.getElementById('dppPartNumber').textContent = data.productOverview.partNumber;
            document.getElementById('dppDescription').textContent = data.productOverview.description;
            document.getElementById('dppApplication').textContent = data.productOverview.application;
            document.getElementById('dppBomTable').innerHTML = data.billOfMaterials.map(item => `<tr><td>${item.item}</td><td>${item.quantity}</td><td>${item.partName}</td><td>${item.description}</td><td>${item.material}</td></tr>`).join('');
            
            const techSpecsContainer = document.getElementById('dppTechSpecs');
            let techSpecsHtml = '';
            for (const key in data.technicalSpecifications) {
                let value = data.technicalSpecifications[key];
                if (typeof value === 'object') value = Object.entries(value).map(([sk, sv]) => `${sk}: ${sv}`).join(', ');
                techSpecsHtml += `<div class="dpp-item"><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> <span>${value}</span></div>`;
            }
            techSpecsContainer.innerHTML = techSpecsHtml;
            document.getElementById('dppFeatures').innerHTML = data.featuresAndBenefits.map(item => `<li>${item}</li>`).join('');
            dppModal.classList.add('active');
        }
        // --- END OF RESTORED LOGIC ---

        document.querySelector('#task2 .inventory-table').addEventListener('click', (e) => {
            const target = e.target;
            const productId = target.dataset.id;
            if (!productId) return;

            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            if (target.classList.contains('view-btn')) {
                if (product.file) window.open(URL.createObjectURL(product.file), '_blank');
            } else if (target.classList.contains('calculate-lca-btn-inline')) {
                target.textContent = "Calculating...";
                setTimeout(() => {
                    product.lca = parseFloat((Math.random() * 0.3 + 0.1).toFixed(3));
                    renderInventoryTables();
                    updateDashboardCharts();
                    
                    if (!isFirstLcaDone) {
                        statusLcaText.textContent = 'First LCA Calculation';
                        statusLca.textContent = 'Completed';
                        statusLca.classList.remove('not-started');
                        statusLca.classList.add('completed');
                        isFirstLcaDone = true;
                    }
                }, 1000);
            } else if(target.classList.contains('dpp-link')) {
                e.preventDefault();
                populateAndShowDpp();
            }
        });

        efficiencyTargetInput.addEventListener('input', updateDashboardCharts);
        updateDashboardCharts();
        renderInventoryTables();
    });
</script>
</body>
</html>

