<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonX - Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Hammersmith+One&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/CarbonX-icon(dark).png" type="image/png" media="(prefers-color-scheme: dark)">
    <link rel="icon" href="assets/CarbonX-icon(light).png" type="image/png" media="(prefers-color-scheme: light)">
<style>
    /* Styles are mostly unchanged and collapsed for brevity */
    :root {
        color-scheme: light dark;
        --navy: #223f43;
        --blue: #59A5B2;
        --light-blue: #c5e4e7;
        --cream: #f1e0ce;
        --yellow: #fbcc58;
        --black: #020202;
        --white: #f4f4f4;
        --grey: #eaeaea;
        --dark-grey: #a9a9a9;
        --danger-color: #ef4444;
        --body-bg: light-dark(var(--grey), var(--black));
        --card-bg: light-dark(var(--white), #1c1c1e);
        --border-color: light-dark(#e5e7eb, #3a3a3c);
        --text-dark: light-dark(var(--black), var(--white));
        --text-muted: light-dark(#6b7280, #8e8e93);
        --modal-bg: light-dark(var(--white), #2c2c2e);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Figtree', sans-serif; background-color: var(--body-bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 80px; background-color: var(--card-bg); padding: 30px 15px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid var(--border-color); flex-shrink: 0; transition: width 0.3s ease; overflow-x: hidden; }
    .sidebar.expanded { width: 240px; }
    .sidebar-top, .sidebar-bottom { display: flex; flex-direction: column; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 50px; flex-shrink: 0; height: 30px; justify-content: center; }
    .nav-menu { display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 500; color: var(--text-dark); text-decoration: none; white-space: nowrap; }
    .nav-item.active { background-color: light-dark(var(--navy), var(--blue)); color: light-dark(var(--white), var(--black)); }
    .nav-item:not(.active):hover { background-color: var(--border-color); }
    .nav-item svg { width: 24px; height: 24px; flex-shrink: 0; margin-right: 18px; }
    .nav-item span { display: none; /* Hide span by default */ opacity: 0; transition: opacity 0.2s; }
    .sidebar.expanded .nav-item span { display: inline; /* Show span when expanded */ opacity: 1; }
    .user-profile { display: flex; align-items: center; gap: 10px; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px; text-decoration: none; color: inherit; justify-content: center; } /* Center avatar */
    .sidebar.expanded .user-profile { justify-content: flex-start; } /* Align left when expanded */
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--dark-grey); color: var(--white); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .user-info { display: none; /* Hide user info by default */ opacity: 0; transition: opacity 0.2s; }
    .sidebar.expanded .user-info { display: block; /* Show user info when expanded */ opacity: 1; }
    .user-info .name { font-weight: 600; color: var(--text-dark); }
    .user-info .company { font-size: 12px; color: var(--text-muted); }
    .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    header .title h1 { font-size: 36px; font-weight: bold; }
    .inventory-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-container { position: relative; width: 350px; }
    .search-container input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-dark); font-size: 14px; }
    .search-container svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 18px; height: 18px; }
    .add-new-btn { background-color: var(--yellow); color: var(--black); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .product-count { font-size: 14px; color: var(--text-muted); font-weight: 500; }
    .inventory-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); overflow: hidden; }
    .inventory-table th, .inventory-table td { text-align: left; padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .inventory-table th { font-weight: 500; font-size: 14px; color: var(--text-muted); }
    .inventory-table td { font-size: 14px; font-weight: 500; }
    .impact-value { font-weight: 600; }
    .impact-unit { font-size: 0.9em; color: var(--text-muted); margin-left: 4px;}
    .impact-na { font-style: italic; color: var(--text-muted); }
    .btn-delete { background-color: light-dark(#fee2e2, #5c2b2b); color: light-dark(#991b1b, #fca5a5); border: none; font-weight: 600; padding: 6px 15px; border-radius: 6px; cursor: pointer; }
    .btn-calculate { background-color: var(--light-blue); color: var(--navy); border: none; font-weight: 600; padding: 6px 15px; border-radius: 6px; cursor: pointer; margin-left: 8px; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--modal-bg); padding: 30px; border-radius: 16px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); animation: slideDown 0.3s; color: var(--text-dark); display: flex; flex-direction: column; }
    #addProductModal .modal-content { max-width: 600px; max-height: 80vh; }
    #confirmDeleteModal .modal-content { max-width: 450px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .modal-header h2 { font-size: 24px; font-weight: 700; }
    .close-modal-btn { background: none; border: none; font-size: 30px; cursor: pointer; color: var(--text-muted); line-height: 1; }
    .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
    .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }
    .modal-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
    .btn-secondary { background-color: var(--body-bg); color: var(--text-dark); border: 1px solid var(--border-color); }
    .btn-danger { background-color: var(--danger-color); color: var(--white); }
    #addProductForm .form-group { margin-bottom: 15px; }
    #addProductForm label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; }
    #addProductForm input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); color: var(--text-dark); }
    .form-submit-btn { padding: 14px; background-color: var(--yellow); color: var(--black); font-weight: 700; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; width: auto; }
    .form-submit-btn:disabled { background-color: var(--dark-grey); cursor: not-allowed; }

    .suggestions-container { margin-top: 5px; border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; background-color: var(--card-bg); }
    .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: var(--body-bg); }
    .suggestion-item.selected { background-color: var(--light-blue); color: var(--navy); font-weight: 600; }
    .suggestion-count { margin-top: 10px; font-size: 13px; color: var(--text-muted); }
    .no-suggestions { padding: 10px 12px; font-size: 13px; color: var(--text-muted); font-style: italic; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-top">
        <div class="logo"><picture><source srcset="assets/CarbonX-icon(dark).png" media="(prefers-color-scheme: dark)"><img src="assets/CarbonX-icon(light).png" alt="Logo" width="30"></picture></div>
        <nav class="nav-menu">
             <a href="dashboard.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> <span>Dashboard</span> </a>
             <a href="inventory.html" class="nav-item active"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> <span>Inventory</span> </a>
             <a href="analytics.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> <span>Analytics</span> </a>
             <a href="network.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> <span>Network</span> </a>
             <a href="report.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> <span>Report</span> </a>
             <a href="chat.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> <span>AI Chat</span> </a>
        </nav>
    </div>
    <div class="sidebar-bottom">
        <a href="settings.html" class="user-profile"><div class="user-avatar" id="user-avatar"></div><div class="user-info"><div class="name" id="user-name"></div><div class="company" id="user-company"></div></div></a>
    </div>
</div>

<main class="main-content">
    <header>
        <div class="title">
            <h1>Inventory</h1>
        </div>
    </header>

    <div class="inventory-controls">
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="search" id="inventorySearch" placeholder="Search your inventory...">
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <span class="product-count" id="inventoryCount">0 products in inventory</span>
            <button class="add-new-btn">Add New Product</button>
        </div>
    </div>

    <table class="inventory-table">
        <thead><tr><th>Product Name</th><th>kgCO2e (Climate Change, 1kg)</th><th>Actions</th></tr></thead>
        <tbody>
            <tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--text-muted);">Your added inventory products will appear here.</td></tr>
        </tbody>
    </table>
</main>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h2>Add Product to Inventory</h2><button class="close-modal-btn">&times;</button></div>
        <form id="addProductForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="productSearchInputModal">Search Available Products</label>
                    <input type="text" id="productSearchInputModal" placeholder="Start typing product name..." autocomplete="off">
                </div>
                <div class="suggestion-count" id="suggestionCount"></div>
                <div class="suggestions-container" id="productSuggestions" style="display: none;">
                     <!-- Suggestions loaded here -->
                </div>
            </div>
             <div class="modal-actions">
                 <button type="button" class="modal-btn btn-secondary close-modal-btn">Cancel</button>
                <button type="submit" class="modal-btn btn-primary form-submit-btn" id="addProductSubmitBtn" style="width: auto; margin-top:0;" disabled>Add Selected Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Deletion</h2><button class="close-modal-btn">&times;</button></div>
        <div class="modal-body">
            <p>Are you sure you want to remove this product from your inventory? This action cannot be undone.</p>
            <p style="margin-top: 10px; font-weight: 600;" id="productNameToDelete"></p>
            <div class="modal-actions"><button id="cancelDeleteBtn" class="modal-btn btn-secondary">Cancel</button><button id="confirmDeleteBtn" class="modal-btn btn-danger">Confirm Remove</button></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = "http://localhost:8080/api";
        // --- State Variables ---
        // userInventory now stores objects like {id: DB_ID, name: "Product Name", climateChangeImpact: 12.345, impactUnit: "kg CO2 eq."}
        let userInventory = JSON.parse(sessionStorage.getItem('userInventoryWithImpacts')) || [];
        let currentSuggestions = [];
        let selectedProductToAdd = null; // Holds {id, name} of product selected in modal
        let productIdToDelete = null;
        let inventorySearchDebounceTimer;
        let suggestionDebounceTimer;

        // --- DOM Elements ---
        const mainTableBody = document.querySelector('.inventory-table tbody');
        const addProductModal = document.getElementById('addProductModal');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const inventorySearchInput = document.getElementById('inventorySearch');
        const inventoryCountSpan = document.getElementById('inventoryCount');
        const productSearchInputModal = document.getElementById('productSearchInputModal');
        const productSuggestionsContainer = document.getElementById('productSuggestions');
        const suggestionCountSpan = document.getElementById('suggestionCount');
        const addProductSubmitBtn = document.getElementById('addProductSubmitBtn');

        // --- Initialization ---
        initializePage();

        function initializePage() {
            initializeUserInterface();
            renderInventoryTable(userInventory); // Render inventory from sessionStorage on load
            // Optional: Add a backend status check here if desired
        }

        // --- Main Inventory Table Search ---
        inventorySearchInput.addEventListener('input', () => {
             clearTimeout(inventorySearchDebounceTimer);
             inventorySearchDebounceTimer = setTimeout(filterAndRenderInventoryTable, 300);
        });

        function filterAndRenderInventoryTable() {
             const searchTerm = inventorySearchInput.value.toLowerCase();
             // Filter the userInventory array based on the name
             const filteredInventory = userInventory.filter(product =>
                 product.name.toLowerCase().includes(searchTerm)
             );
             renderInventoryTable(filteredInventory); // Render main table with filtered user inventory
        }

        // --- Render Main Inventory Table (Displays userInventory) ---
        function renderInventoryTable(productsToDisplay) {
            mainTableBody.innerHTML = productsToDisplay.length > 0
                ? productsToDisplay.map(createInventoryRowHTML).join('')
                : `<tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    ${inventorySearchInput.value ? 'No products in your inventory match "' + escapeHtml(inventorySearchInput.value) + '"' : 'Your inventory is empty. Add products using the button above.'}
                   </td></tr>`; // Updated colspan to 3
            inventoryCountSpan.textContent = `${productsToDisplay.length} of ${userInventory.length} products in inventory`;
        }

         function createInventoryRowHTML(product) {
            // Display pre-calculated impact if available in userInventory
            let impactHtml = '<span class="impact-na">N/A</span>';
            if (product.climateChangeImpact != null && !isNaN(product.climateChangeImpact)) { // Check value exists and is a number
                 const impactFormatted = parseFloat(product.climateChangeImpact).toPrecision(3);
                 impactHtml = `<span class="impact-value">${impactFormatted}</span><span class="impact-unit">${escapeHtml(product.impactUnit || '')}</span>`;
            }

            return `<tr>
                <td>${escapeHtml(product.name)}</td>
                <td>${impactHtml}</td> <!-- Display impact -->
                <td>
                    <!-- RENAMED button text -->
                    <button class="btn-calculate" data-id="${product.id}" data-name="${escapeHtml(product.name)}">Calculate</button>
                    <button class="btn-delete" data-id="${product.id}">Remove</button>
                </td>
            </tr>`;
        }

        // --- Add Product Modal Logic ---
        document.querySelector('.add-new-btn').addEventListener('click', () => {
            productSearchInputModal.value = '';
            productSuggestionsContainer.innerHTML = '';
            productSuggestionsContainer.style.display = 'none';
            suggestionCountSpan.textContent = 'Type to search all available products...';
            selectedProductToAdd = null;
            addProductSubmitBtn.disabled = true;
            addProductModal.classList.add('active');
            productSearchInputModal.focus();
        });

        // Live search inside the modal (fetches from /api/products)
        productSearchInputModal.addEventListener('input', () => {
            clearTimeout(suggestionDebounceTimer);
            const searchTerm = productSearchInputModal.value.trim();
            clearSelectedSuggestionStyle();
            selectedProductToAdd = null;
            addProductSubmitBtn.disabled = true;

            if (searchTerm.length < 2) {
                productSuggestionsContainer.innerHTML = '';
                productSuggestionsContainer.style.display = 'none';
                suggestionCountSpan.textContent = searchTerm.length === 0 ? 'Type to search all available products...' : 'Keep typing...';
                return;
            }

            suggestionCountSpan.textContent = 'Searching...';
            suggestionDebounceTimer = setTimeout(() => {
                fetchSuggestions(searchTerm);
            }, 300);
        });

        async function fetchSuggestions(name) {
             try {
                const encodedName = encodeURIComponent(name);
                // Fetch suggestions ({id, name}) from the simple product endpoint
                currentSuggestions = await apiRequest(`/products?name=${encodedName}`, 'GET');
                renderSuggestions(currentSuggestions);
            } catch (error) {
                console.error('Failed to fetch suggestions:', error);
                productSuggestionsContainer.innerHTML = `<div class="no-suggestions" style="color: red;">Error fetching suggestions.</div>`;
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = 'Error fetching data';
            }
        }

        function renderSuggestions(suggestions) {
            productSuggestionsContainer.innerHTML = '';
            if (suggestions.length > 0) {
                 suggestions.forEach(product => { // product here is {id, name}
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.textContent = product.name;
                    itemDiv.dataset.productId = product.id;

                    itemDiv.addEventListener('click', () => {
                        clearSelectedSuggestionStyle();
                        itemDiv.classList.add('selected');
                        selectedProductToAdd = { id: product.id, name: product.name }; // Store basic info
                        addProductSubmitBtn.disabled = false;
                        suggestionCountSpan.textContent = `Selected: ${product.name}`;
                        // Optional: Keep suggestions displayed or hide
                        // productSuggestionsContainer.style.display = 'none';
                    });
                    productSuggestionsContainer.appendChild(itemDiv);
                });
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = `${suggestions.length} match(es) found. Click one to select.`;
            } else {
                productSuggestionsContainer.innerHTML = `<div class="no-suggestions">No products found matching "${escapeHtml(productSearchInputModal.value)}".</div>`;
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = 'No matches found.';
            }
        }

        function clearSelectedSuggestionStyle() {
            productSuggestionsContainer.querySelectorAll('.suggestion-item.selected').forEach(el => el.classList.remove('selected'));
        }

        // Handle adding the selected product to the user inventory
        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (selectedProductToAdd) {
                 if (!userInventory.some(p => p.id === selectedProductToAdd.id)) {
                    // Add basic info, LCA needs calculation
                    const newItem = {
                         id: selectedProductToAdd.id,
                         name: selectedProductToAdd.name,
                         climateChangeImpact: null, // Start with null impact
                         impactUnit: null
                     };
                    userInventory.push(newItem);
                    sessionStorage.setItem('userInventoryWithImpacts', JSON.stringify(userInventory));
                    filterAndRenderInventoryTable(); // Update the main table
                    addProductModal.classList.remove('active');
                     // Trigger calculation right away for the newly added item
                     findAndCalculateLCA(newItem.name); // Calculate immediately
                } else {
                    alert(`'${selectedProductToAdd.name}' is already in your inventory.`);
                }
            } else {
                alert('Please select a product from the suggestions first.');
            }
        });


        // --- Delete & Calculate Logic (Operating on User Inventory) ---
        mainTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const deleteButton = target.closest('.btn-delete');
            const calculateButton = target.closest('.btn-calculate'); // Changed variable name

            if (deleteButton) {
                productIdToDelete = parseInt(deleteButton.dataset.id, 10);
                const product = userInventory.find(p => p.id === productIdToDelete);
                if (product) {
                    document.getElementById('productNameToDelete').textContent = `"${escapeHtml(product.name)}"`;
                    confirmDeleteModal.classList.add('active');
                }
            } else if (calculateButton) { // Changed variable name
                 const productName = calculateButton.dataset.name;
                 if(productName) {
                    findAndCalculateLCA(productName); // Trigger calculation
                 }
            }
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => { confirmDeleteModal.classList.remove('active'); productIdToDelete = null; });
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (productIdToDelete !== null) {
                userInventory = userInventory.filter(p => p.id !== productIdToDelete);
                sessionStorage.setItem('userInventoryWithImpacts', JSON.stringify(userInventory));
                filterAndRenderInventoryTable(); // Update main table
            }
            confirmDeleteModal.classList.remove('active');
            productIdToDelete = null;
        });

        // UPDATED: Calculate LCA function now updates the local inventory state
        async function findAndCalculateLCA(productName) {
            // Find the item in the current user inventory to update later
            const inventoryItemIndex = userInventory.findIndex(p => p.name === productName);
             if (inventoryItemIndex === -1) {
                 console.error("Attempted to calculate LCA for a product not in the user inventory:", productName);
                 return; // Should not happen with current UI logic
             }

            alert(`Sending request to calculate LCA for: ${productName}`);
            // Optionally: Show a loading state in the table row
            userInventory[inventoryItemIndex].climateChangeImpact = 'Calculating...'; // Temporary state
            renderInventoryTable(userInventory.filter(p => inventorySearchInput.value === '' || p.name.toLowerCase().includes(inventorySearchInput.value.toLowerCase()))); // Re-render

            try {
                // Call backend to perform calculation and save results
                const result = await apiRequest('/lca/calculate', 'POST', { productName: productName });
                console.log('LCA Result from backend:', result);
                alert(`LCA for '${productName}' calculated and saved successfully! Status: ${result.message}`);

                // --- Fetch the updated impact value ---
                // We assume the calculation saved the data. Now fetch the specific item again.
                // A more optimized way would be if the backend returned the calculated value.
                const updatedInventoryData = await apiRequest('/inventory?search=' + encodeURIComponent(productName), 'GET');
                const updatedItem = updatedInventoryData.find(p => p.name === productName);

                if (updatedItem) {
                    userInventory[inventoryItemIndex].climateChangeImpact = updatedItem.climateChangeImpact;
                    userInventory[inventoryItemIndex].impactUnit = updatedItem.impactUnit;
                } else {
                     userInventory[inventoryItemIndex].climateChangeImpact = 'Error fetching update';
                }
                sessionStorage.setItem('userInventoryWithImpacts', JSON.stringify(userInventory));
                filterAndRenderInventoryTable(); // Re-render table with the new value

            } catch (error) {
                console.error(`LCA Calculation failed for ${productName}:`, error);
                alert(`Error calculating LCA for ${productName}. Check the browser console for details.`);
                 // Revert loading state on error
                 userInventory[inventoryItemIndex].climateChangeImpact = 'Error';
                 sessionStorage.setItem('userInventoryWithImpacts', JSON.stringify(userInventory));
                 filterAndRenderInventoryTable();
            }
        }

        // --- Modal Closing ---
        document.querySelectorAll('.modal-overlay .close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('active')));
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); }));

        // --- Helper & UI Init Functions ---
        function initializeUserInterface(){const e=localStorage.getItem("signupFullName")||"John Doe",t=localStorage.getItem("companyName")||"Company Name";document.getElementById("user-name").textContent=e,document.getElementById("user-company").textContent=t;let a="JD";e&&(a=(nameParts=e.split(" "))[0].charAt(0)+(nameParts.length>1?nameParts[nameParts.length-1].charAt(0):"")),document.getElementById("user-avatar").textContent=a.toUpperCase();const o=document.querySelector(".sidebar");o.addEventListener("mouseenter",()=>o.classList.add("expanded")),o.addEventListener("mouseleave",()=>o.classList.remove("expanded"))}
        async function apiRequest(endpoint, method, body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(API_URL + endpoint, options);
            if (!response.ok) throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
            if (method.toUpperCase() !== 'DELETE' && response.status !== 204) return response.json();
        }
        function escapeHtml(text) { return text?.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") || ''; }
    });
</script>
</body>
</html>

