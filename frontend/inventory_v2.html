<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonX - Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Hammersmith+One&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/CarbonX-icon(dark).png" type="image/png" media="(prefers-color-scheme: dark)">
    <link rel="icon" href="assets/CarbonX-icon(light).png" type="image/png" media="(prefers-color-scheme: light)">
<style>
    /* Styles are mostly unchanged and collapsed for brevity */
    :root {
        color-scheme: light dark;
        --navy: #223f43;
        --blue: #59A5B2;
        --light-blue: #c5e4e7;
        --cream: #f1e0ce;
        --yellow: #fbcc58;
        --black: #020202;
        --white: #f4f4f4;
        --grey: #eaeaea;
        --dark-grey: #a9a9a9;
        --danger-color: #ef4444;
        --body-bg: light-dark(var(--grey), var(--black));
        --card-bg: light-dark(var(--white), #1c1c1e);
        --border-color: light-dark(#e5e7eb, #3a3a3c);
        --text-dark: light-dark(var(--black), var(--white));
        --text-muted: light-dark(#6b7280, #8e8e93);
        --modal-bg: light-dark(var(--white), #2c2c2e);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Figtree', sans-serif; background-color: var(--body-bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 80px; background-color: var(--card-bg); padding: 30px 15px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid var(--border-color); flex-shrink: 0; transition: width 0.3s ease; overflow-x: hidden; }
    .sidebar.expanded { width: 240px; }
    .sidebar-top, .sidebar-bottom { display: flex; flex-direction: column; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 50px; flex-shrink: 0; height: 30px; justify-content: center; }
    .nav-menu { display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 500; color: var(--text-dark); text-decoration: none; white-space: nowrap; }
    .nav-item.active { background-color: light-dark(var(--navy), var(--blue)); color: light-dark(var(--white), var(--black)); }
    .nav-item:not(.active):hover { background-color: var(--border-color); }
    .nav-item svg { width: 24px; height: 24px; flex-shrink: 0; margin-right: 18px; }
    .nav-item span { display: none; /* Hide span by default */ opacity: 0; transition: opacity 0.2s; }
    .sidebar.expanded .nav-item span { display: inline; /* Show span when expanded */ opacity: 1; }
    .user-profile { display: flex; align-items: center; gap: 10px; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px; text-decoration: none; color: inherit; justify-content: center; } /* Center avatar */
    .sidebar.expanded .user-profile { justify-content: flex-start; } /* Align left when expanded */
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--dark-grey); color: var(--white); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .user-info { display: none; /* Hide user info by default */ opacity: 0; transition: opacity 0.2s; }
    .sidebar.expanded .user-info { display: block; /* Show user info when expanded */ opacity: 1; }
    .user-info .name { font-weight: 600; color: var(--text-dark); }
    .user-info .company { font-size: 12px; color: var(--text-muted); }
    .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    header .title h1 { font-size: 36px; font-weight: bold; }
    .inventory-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-container { position: relative; width: 350px; }
    .search-container input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-dark); font-size: 14px; }
    .search-container svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 18px; height: 18px; }
    .add-new-btn { background-color: var(--yellow); color: var(--black); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .product-count { font-size: 14px; color: var(--text-muted); font-weight: 500; }
    .inventory-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); overflow: hidden; }
    .inventory-table th, .inventory-table td { text-align: left; padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .inventory-table th { font-weight: 500; font-size: 14px; color: var(--text-muted); }
    .inventory-table td { font-size: 14px; font-weight: 500; }

    /* --- NEW STYLES FOR WEIGHT INPUT --- */
    .inventory-table input[type="number"] {
        width: 80px;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--body-bg);
        color: var(--text-dark);
        font-size: 14px;
        text-align: right;
        transition: background-color 0.2s ease; /* For visual feedback on save */
    }
    /* --- END NEW STYLES --- */

    .impact-value { font-weight: 600; }
    .impact-unit { font-size: 0.9em; color: var(--text-muted); margin-left: 4px;}
    /* Update message for client-side calculation */
    .impact-na, .impact-calculating, .impact-error { font-style: italic; color: var(--text-muted); display: flex; align-items: center; gap: 8px;}
    .impact-error { color: var(--danger-color); font-weight: 600; }
    .btn-delete { background-color: light-dark(#fee2e2, #5c2b2b); color: light-dark(#991b1b, #fca5a5); border: none; font-weight: 600; padding: 6px 15px; border-radius: 6px; cursor: pointer; }
    .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border-color); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--modal-bg); padding: 30px; border-radius: 16px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); animation: slideDown 0.3s; color: var(--text-dark); display: flex; flex-direction: column; }
    #addProductModal .modal-content { max-width: 600px; max-height: 80vh; }
    #confirmDeleteModal .modal-content { max-width: 450px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .modal-header h2 { font-size: 24px; font-weight: 700; }
    .close-modal-btn { background: none; border: none; font-size: 30px; cursor: pointer; color: var(--text-muted); line-height: 1; }
    .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
    .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }
    .modal-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
    .btn-secondary { background-color: var(--body-bg); color: var(--text-dark); border: 1px solid var(--border-color); }
    .btn-danger { background-color: var(--danger-color); color: var(--white); }
    #addProductForm .form-group { margin-bottom: 15px; }
    #addProductForm label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; }
    #addProductForm input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); color: var(--text-dark); }
    .form-submit-btn { padding: 14px; background-color: var(--yellow); color: var(--black); font-weight: 700; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; width: auto; }
    .form-submit-btn:disabled { background-color: var(--dark-grey); cursor: not-allowed; }

    .suggestions-container { margin-top: 5px; border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; background-color: var(--card-bg); }
    .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: var(--body-bg); }
    .suggestion-item.selected { background-color: var(--light-blue); color: var(--navy); font-weight: 600; }
    .suggestion-count { margin-top: 10px; font-size: 13px; color: var(--text-muted); }
    .no-suggestions { padding: 10px 12px; font-size: 13px; color: var(--text-muted); font-style: italic; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-top">
        <div class="logo"><picture><source srcset="assets/CarbonX-icon(dark).png" media="(prefers-color-scheme: dark)"><img src="assets/CarbonX-icon(light).png" alt="Logo" width="30"></picture></div>
        <nav class="nav-menu">
             <a href="dashboard.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> <span>Dashboard</span> </a>
             <a href="inventory_v2.html" class="nav-item active"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> <span>Inventory</span> </a>
             <a href="analytics_v2.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> <span>Analytics</span> </a>
             <a href="network.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> <span>Network</span> </a>
             <a href="report.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> <span>Report</span> </a>
             <a href="chat.html" class="nav-item"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> <span>AI Chat</span> </a>
        </nav>
    </div>
    <div class="sidebar-bottom">
        <a href="settings.html" class="user-profile"><div class="user-avatar" id="user-avatar"></div><div class="user-info"><div class="name" id="user-name"></div><div class="company" id="user-company"></div></div></a>
    </div>
</div>

<main class="main-content">
    <header>
        <div class="title">
            <h1>Inventory</h1>
        </div>
    </header>

    <div class="inventory-controls">
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="search" id="inventorySearch" placeholder="Search your inventory...">
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <span class="product-count" id="inventoryCount">0 products in inventory</span>
            <button class="add-new-btn">Add New Product</button>
        </div>
    </div>

    <table class="inventory-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Weight (kg)</th>
                <th>Total kgCO2e (Climate Change)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</main>

<div id="addProductModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h2>Add Product to Inventory</h2><button class="close-modal-btn">&times;</button></div>
        <form id="addProductForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="productSearchInputModal">Search Available Products (from openLCA)</label>
                    <input type="text" id="productSearchInputModal" placeholder="Start typing product name..." autocomplete="off">
                </div>
                <div class="suggestion-count" id="suggestionCount"></div>
                <div class="suggestions-container" id="productSuggestions" style="display: none;">
                     </div>
            </div>
             <div class="modal-actions">
                 <button type="button" class="modal-btn btn-secondary close-modal-btn">Cancel</button>
                <button type="submit" class="modal-btn btn-primary form-submit-btn" id="addProductSubmitBtn" style="width: auto; margin-top:0;" disabled>Add Selected Product</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Removal</h2><button class="close-modal-btn">&times;</button></div>
        <div class="modal-body">
            <p>Are you sure you want to remove this product from your inventory? This action cannot be undone.</p>
            <p style="margin-top: 10px; font-weight: 600;" id="productNameToDelete"></p>
            <div class="modal-actions"><button id="cancelDeleteBtn" class="modal-btn btn-secondary">Cancel</button><button id="confirmDeleteBtn" class="modal-btn btn-danger">Confirm Remove</button></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = "http://localhost:8080/api";
        // --- State Variables ---
        let currentInventory = []; 
        let currentSuggestions = [];
        let selectedProductToAdd = null;
        let productIdToDelete = null; 
        let inventorySearchDebounceTimer;
        let suggestionDebounceTimer;
        let weightUpdateTimeout = {}; 

        // --- DOM Elements ---
        const mainTableBody = document.querySelector('.inventory-table tbody');
        const addProductModal = document.getElementById('addProductModal');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const inventorySearchInput = document.getElementById('inventorySearch');
        const inventoryCountSpan = document.getElementById('inventoryCount');
        const productSearchInputModal = document.getElementById('productSearchInputModal');
        const productSuggestionsContainer = document.getElementById('productSuggestions');
        const suggestionCountSpan = document.getElementById('suggestionCount');
        const addProductSubmitBtn = document.getElementById('addProductSubmitBtn');

        // --- Initialization ---
        initializePage();

        function initializePage() {
            initializeUserInterface();
            fetchAndRenderInventory();
        }

        // --- Fetch and Render Main Inventory Table ---
        async function fetchAndRenderInventory(searchTerm = '') {
             showLoadingInTable(); 
             try {
                let url = `${API_URL}/inventory`;
                if (searchTerm) {
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }
                const response = await fetch(url);
                if (!response.ok) {
                     throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                }
                currentInventory = await response.json();
                renderInventoryTable(currentInventory);
             } catch (error) {
                 console.error("Error fetching inventory:", error);
                 showErrorInTable("Failed to load inventory. Please check backend connection.");
             }
        }

        function renderInventoryTable(productsToDisplay) {
            mainTableBody.innerHTML = '';
            if (productsToDisplay.length > 0) {
                 productsToDisplay.forEach(item => {
                     const row = document.createElement('tr');
                     row.dataset.inventoryItemId = item.id;
                     row.innerHTML = createInventoryRowHTML(item);
                     mainTableBody.appendChild(row);
                 });
            } else {
                const message = inventorySearchInput.value
                    ? `No products in your inventory match "${escapeHtml(inventorySearchInput.value)}"`
                    : 'Your inventory is empty. Add products using the button above.';
                // COLSPAN = 4
                mainTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">${message}</td></tr>`;
            }
             
             const totalCount = currentInventory.length;
             inventoryCountSpan.textContent = `${productsToDisplay.length} of ${totalCount} products shown`;
        }

        function createInventoryRowHTML(item) {
            const baseImpact = item.climateChangeImpact ? parseFloat(item.climateChangeImpact) : null;
            const itemWeight = (item.weight !== null && item.weight !== undefined && !isNaN(parseFloat(item.weight)) && parseFloat(item.weight) > 0) ? parseFloat(item.weight) : 1;
            
            let impactHtml = '';
            let totalImpact = null;

            if (baseImpact === null) { 
                 impactHtml = `<span class="impact-na">Not Calculated</span>`;
            } else if (item.climateChangeImpact === 'Error') { 
                 impactHtml = `<span class="impact-error">Calculation Error</span>`;
            } else {
                 // *** CLIENT-SIDE CALCULATION: Total Impact = Base Impact * Current Weight ***
                 totalImpact = baseImpact * itemWeight;
                 const impactFormatted = totalImpact.toPrecision(3);
                 impactHtml = `<span class="impact-value">${impactFormatted}</span><span class="impact-unit">${escapeHtml(item.impactUnit || '')}</span>`;
            }

            // The impact unit and base impact are stored in the input data attributes for real-time updates.
            return `
                <td>${escapeHtml(item.name)}</td>
                <td>
                    <input 
                        type="number" step="any" min="0.01" 
                        value="${itemWeight}" 
                        data-inventory-item-id="${item.id}" 
                        data-base-impact="${baseImpact || 'N/A'}"
                        data-impact-unit="${escapeHtml(item.impactUnit || '')}"
                        class="weight-input"
                    >
                </td>
                <td class="impact-cell" data-inventory-item-id="${item.id}">
                    ${impactHtml}
                </td>
                <td>
                    <button class="btn-delete" data-inventory-item-id="${item.id}">Remove</button>
                </td>
            `;
        }

        function showLoadingInTable() {
            mainTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px;"><div class="loading" style="margin:auto;"></div></td></tr>`;
        }
        function showErrorInTable(message) {
             mainTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--danger-color);">${escapeHtml(message)}</td></tr>`;
        }


        // --- Main Inventory Table Search ---
        inventorySearchInput.addEventListener('input', () => {
             clearTimeout(inventorySearchDebounceTimer);
             inventorySearchDebounceTimer = setTimeout(() => {
                 fetchAndRenderInventory(inventorySearchInput.value);
             }, 300);
        });


        // --- Weight Update Logic (Client-side multiplication) ---

        function updateImpactCell(inputElement, newWeight) {
             const baseImpactStr = inputElement.dataset.baseImpact;
             const unit = inputElement.dataset.impactUnit;
             // Ensure we are robustly finding the impact cell
             const impactCell = inputElement.closest('tr')?.querySelector('.impact-cell');

             if (!impactCell) return; // Exit if impact cell not found

             if (baseImpactStr === 'N/A') {
                 impactCell.innerHTML = `<span class="impact-na">Not Calculated</span>`;
                 return;
             }

             const baseImpact = parseFloat(baseImpactStr);
             if (isNaN(baseImpact) || isNaN(newWeight) || newWeight <= 0) {
                 impactCell.innerHTML = `<span class="impact-na">Invalid Weight/Impact</span>`;
                 return;
             }
             
             // *** PERFORM CLIENT-SIDE CALCULATION ***
             const totalImpact = baseImpact * newWeight;
             const impactFormatted = totalImpact.toPrecision(3);

             impactCell.innerHTML = `<span class="impact-value">${impactFormatted}</span><span class="impact-unit">${escapeHtml(unit || '')}</span>`;

             // Update currentInventory state
             const inventoryItemId = parseInt(inputElement.dataset.inventoryItemId, 10);
             const itemIndex = currentInventory.findIndex(p => p.id === inventoryItemId);
             if (itemIndex > -1) {
                currentInventory[itemIndex].weight = newWeight;
                // Note: We intentionally don't update climateChangeImpact here, as it represents the BASE impact.
             }
        }


        // Listener for real-time input and debouncing
        mainTableBody.addEventListener('input', (e) => {
            const target = e.target;
            if (target.classList.contains('weight-input')) {
                const inventoryItemId = parseInt(target.dataset.inventoryItemId, 10);
                const newWeight = parseFloat(target.value);

                if (isNaN(newWeight) || newWeight <= 0) {
                     target.style.backgroundColor = 'var(--danger-color)';
                     return;
                }

                // Update UI instantly
                updateImpactCell(target, newWeight);
                target.style.backgroundColor = 'var(--light-blue)';

                // Clear any existing timer and set new debounced API call
                if (weightUpdateTimeout[inventoryItemId]) {
                    clearTimeout(weightUpdateTimeout[inventoryItemId]);
                }
                
                weightUpdateTimeout[inventoryItemId] = setTimeout(() => {
                    updateInventoryItemWeight(inventoryItemId, newWeight, target);
                }, 1000); // 1 second debounce
            }
        });

        // Listener for 'blur' to force an immediate save on losing focus
        mainTableBody.addEventListener('blur', (e) => {
            const target = e.target;
            if (target.classList.contains('weight-input')) {
                 const inventoryItemId = parseInt(target.dataset.inventoryItemId, 10);
                 const newWeight = parseFloat(target.value);

                 if (isNaN(inventoryItemId)) return;

                 // Clear debounced timer and force immediate save if valid
                 if (weightUpdateTimeout[inventoryItemId]) {
                    clearTimeout(weightUpdateTimeout[inventoryItemId]);
                    delete weightUpdateTimeout[inventoryItemId];

                    if (!isNaN(newWeight) && newWeight > 0) {
                        updateInventoryItemWeight(inventoryItemId, newWeight, target);
                    } else {
                        // Revert to a valid state if blur happens on invalid value
                        const item = currentInventory.find(p => p.id === inventoryItemId);
                        const revertedWeight = (item && item.weight) || 1;
                        target.value = revertedWeight;
                        target.style.backgroundColor = 'var(--body-bg)';
                        updateImpactCell(target, revertedWeight);
                    }
                } else if (!isNaN(newWeight) && newWeight > 0) {
                    // Force save if value changed and no input event fired recently
                    const currentItem = currentInventory.find(p => p.id === inventoryItemId);
                    const currentWeight = parseFloat((currentItem && currentItem.weight) || 1);
                    if (Math.abs(newWeight - currentWeight) > 0.001) { 
                        updateInventoryItemWeight(inventoryItemId, newWeight, target);
                    } else {
                        target.style.backgroundColor = 'var(--body-bg)';
                    }
                }
            }
        }, true); 

        async function updateInventoryItemWeight(inventoryItemId, newWeight, inputElement) {
             const weightToSave = parseFloat(newWeight.toFixed(2));
             inputElement.value = weightToSave;

             const originalItem = currentInventory.find(p => p.id === inventoryItemId);
             const originalWeight = (originalItem && originalItem.weight) || 1;
             
             try {
                // PUT request to /api/inventory/{id} to save only the weight
                const response = await fetch(`${API_URL}/inventory/${inventoryItemId}`, {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ weight: weightToSave })
                 });

                 if (!response.ok) {
                     throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                 }

                 // Update internal state with saved weight
                 const itemIndex = currentInventory.findIndex(p => p.id === inventoryItemId);
                 if (itemIndex > -1) {
                     currentInventory[itemIndex].weight = weightToSave;
                 }
                 
                 // Success visual feedback (flash yellow)
                 inputElement.style.backgroundColor = 'var(--yellow)';
                 setTimeout(() => {
                     inputElement.style.backgroundColor = 'var(--body-bg)';
                 }, 500);

             } catch (error) {
                 console.error(`Error saving weight for item ID ${inventoryItemId}:`, error);
                 alert(`Failed to save weight: ${error.message}`);

                 // Error visual feedback (flash red) and revert value
                 inputElement.value = originalWeight;
                 updateImpactCell(inputElement, originalWeight);
                 inputElement.style.backgroundColor = 'var(--danger-color)';
                 setTimeout(() => {
                     inputElement.style.backgroundColor = 'var(--body-bg)';
                 }, 1000);
             }
        }

        // --- Add Product Modal Logic ---
        document.querySelector('.add-new-btn').addEventListener('click', () => {
            // Reset modal state
            productSearchInputModal.value = '';
            productSuggestionsContainer.innerHTML = '';
            productSuggestionsContainer.style.display = 'none';
            suggestionCountSpan.textContent = 'Type to search all available products...';
            selectedProductToAdd = null;
            addProductSubmitBtn.disabled = true;
            addProductModal.classList.add('active');
            productSearchInputModal.focus();
        });

        // Live search inside the modal
        productSearchInputModal.addEventListener('input', () => {
            clearTimeout(suggestionDebounceTimer);
            const searchTerm = productSearchInputModal.value.trim();
            clearSelectedSuggestionStyle();
            selectedProductToAdd = null;
            addProductSubmitBtn.disabled = true;

            if (searchTerm.length < 2) { 
                productSuggestionsContainer.innerHTML = '';
                productSuggestionsContainer.style.display = 'none';
                suggestionCountSpan.textContent = searchTerm.length === 0 ? 'Type to search all available products...' : 'Keep typing... (min 2 chars)';
                return;
            }

            suggestionCountSpan.textContent = 'Searching...';
            suggestionDebounceTimer = setTimeout(() => {
                fetchSuggestions(searchTerm);
            }, 300);
        });

        async function fetchSuggestions(name) {
             try {
                const response = await fetch(`${API_URL}/products?name=${encodeURIComponent(name)}`);
                 if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                currentSuggestions = await response.json(); 
                renderSuggestions(currentSuggestions);
            } catch (error) {
                console.error('Failed to fetch suggestions:', error);
                productSuggestionsContainer.innerHTML = `<div class="no-suggestions" style="color: red;">Error fetching suggestions.</div>`;
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = 'Error fetching data';
            }
        }

        function renderSuggestions(suggestions) {
            productSuggestionsContainer.innerHTML = '';
            if (suggestions.length > 0) {
                 suggestions.forEach(product => { 
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.textContent = product.name;
                    itemDiv.dataset.productId = product.id; 

                    itemDiv.addEventListener('click', () => {
                        clearSelectedSuggestionStyle();
                        itemDiv.classList.add('selected');
                        selectedProductToAdd = { id: product.id, name: product.name };
                        addProductSubmitBtn.disabled = false;
                        suggestionCountSpan.textContent = `Selected: ${product.name}`;
                    });
                    productSuggestionsContainer.appendChild(itemDiv);
                });
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = `${suggestions.length} match(es) found. Click one to select.`;
            } else {
                productSuggestionsContainer.innerHTML = `<div class="no-suggestions">No products found matching "${escapeHtml(productSearchInputModal.value)}". Check openLCA sync.</div>`;
                productSuggestionsContainer.style.display = 'block';
                suggestionCountSpan.textContent = 'No matches found.';
            }
        }

        function clearSelectedSuggestionStyle() {
            productSuggestionsContainer.querySelectorAll('.suggestion-item.selected').forEach(el => el.classList.remove('selected'));
        }

        // Handle adding the selected product to the user inventory
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedProductToAdd) {
                alert('Please select a product from the suggestions first.');
                return;
            }

            addProductSubmitBtn.disabled = true;
            addProductSubmitBtn.textContent = 'Adding...';

            try {
                // Initial POST sends weight=1 and triggers full LCA calculation on backend
                const response = await fetch(`${API_URL}/inventory`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ productId: selectedProductToAdd.id, weight: 1 }) 
                 });

                 if (response.status === 409) {
                     alert(`'${selectedProductToAdd.name}' is already in your inventory.`);
                 } else if (!response.ok) {
                     throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                 } else {
                     const addedItemData = await response.json();
                     console.log('Product added:', addedItemData);
                     addProductModal.classList.remove('active');
                     fetchAndRenderInventory(); 
                     // Backend automatically triggers initial calculation
                 }

            } catch (error) {
                console.error('Error adding product to inventory:', error);
                alert(`Failed to add product: ${error.message}`);
            } finally {
                 addProductSubmitBtn.disabled = false;
                 addProductSubmitBtn.textContent = 'Add Selected Product';
            }
        });


        // --- Delete Logic ---
        mainTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const deleteButton = target.closest('.btn-delete');
            
            if (deleteButton) {
                productIdToDelete = parseInt(deleteButton.dataset.inventoryItemId, 10);
                const itemRow = deleteButton.closest('tr');
                
                // *** FIX for TypeError: check if itemRow is valid before accessing cells[] ***
                const productName = (itemRow && itemRow.cells.length > 0) 
                    ? itemRow.cells[0].textContent 
                    : 'this product';
                
                document.getElementById('productNameToDelete').textContent = `"${escapeHtml(productName)}"`;
                confirmDeleteModal.classList.add('active');
            }
        });

        // Confirm Delete Action
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => { confirmDeleteModal.classList.remove('active'); productIdToDelete = null; });
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (productIdToDelete !== null) {
                 try {
                     const response = await fetch(`${API_URL}/inventory/${productIdToDelete}`, { method: 'DELETE' });
                     if (!response.ok) {
                          throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                     }
                     // Remove row visually immediately
                     const rowToRemove = mainTableBody.querySelector(`tr[data-inventory-item-id="${productIdToDelete}"]`);
                     if (rowToRemove) rowToRemove.remove();
                     // Update state and count
                     currentInventory = currentInventory.filter(p => p.id !== productIdToDelete);
                     inventoryCountSpan.textContent = `${currentInventory.length} products in inventory`;
                     if (currentInventory.length === 0) {
                          renderInventoryTable([]); 
                     }
                 } catch (error) {
                     console.error('Error deleting inventory item:', error);
                     alert(`Failed to remove product: ${error.message}`);
                 }
            }
            confirmDeleteModal.classList.remove('active');
            productIdToDelete = null;
        });


        // --- Helper & UI Init Functions ---
        function initializeUserInterface(){const e=localStorage.getItem("signupFullName")||"John Doe",t=localStorage.getItem("companyName")||"Company Name";document.getElementById("user-name").textContent=e,document.getElementById("user-company").textContent=t;let a="JD";e&&(a=(nameParts=e.split(" "))[0].charAt(0)+(nameParts.length>1?nameParts[nameParts.length-1].charAt(0):"")),document.getElementById("user-avatar").textContent=a.toUpperCase();const o=document.querySelector(".sidebar");o.addEventListener("mouseenter",()=>o.classList.add("expanded")),o.addEventListener("mouseleave",()=>o.classList.remove("expanded"))}
        function escapeHtml(text) { return text?.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") || ''; }
        document.querySelectorAll('.modal-overlay .close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('active')));
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); }));
    });
</script>
</body>
</html>